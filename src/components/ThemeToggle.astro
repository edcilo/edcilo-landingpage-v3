---
import Tooltip from './Tooltip.astro';
import { DEFAULT_LOCALE } from '../i18n/config';
import { useTranslations } from '../i18n/utils';

interface Props {
	locale?: string;
}

const locale = Astro.props.locale ?? DEFAULT_LOCALE;
const t = useTranslations(locale);
---

<Tooltip text={t('tooltip.theme.system')}>
	<button
		type="button"
		id="theme-toggle"
		data-locale={locale}
		aria-label="Toggle theme"
		class="cursor-pointer rounded-md p-2 text-muted-foreground hover:text-foreground hover:bg-accent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary"
	>
		<!-- Sun icon (light mode) -->
		<svg
			xmlns="http://www.w3.org/2000/svg"
			fill="none"
			viewBox="0 0 24 24"
			stroke-width="1.5"
			stroke="currentColor"
			class="size-5"
			id="theme-icon-sun"
			style="display:none"
			aria-hidden="true"
		>
			<path
				stroke-linecap="round"
				stroke-linejoin="round"
				d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z"
			></path>
		</svg>

		<!-- Moon icon (dark mode) -->
		<svg
			xmlns="http://www.w3.org/2000/svg"
			fill="none"
			viewBox="0 0 24 24"
			stroke-width="1.5"
			stroke="currentColor"
			class="size-5"
			id="theme-icon-moon"
			style="display:none"
			aria-hidden="true"
		>
			<path
				stroke-linecap="round"
				stroke-linejoin="round"
				d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z"
			></path>
		</svg>

		<!-- Monitor icon (system mode) -->
		<svg
			xmlns="http://www.w3.org/2000/svg"
			fill="none"
			viewBox="0 0 24 24"
			stroke-width="1.5"
			stroke="currentColor"
			class="size-5"
			id="theme-icon-monitor"
			style="display:none"
			aria-hidden="true"
		>
			<path
				stroke-linecap="round"
				stroke-linejoin="round"
				d="M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0 1 15 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25A2.25 2.25 0 0 1 5.25 3h13.5A2.25 2.25 0 0 1 21 5.25Z"
			></path>
		</svg>
	</button>
</Tooltip>

<script>
	type ThemePreference = 'light' | 'dark' | 'system';

	const ICON_IDS: Record<ThemePreference, string> = {
		light: 'theme-icon-sun',
		dark: 'theme-icon-moon',
		system: 'theme-icon-monitor',
	};

	const LABELS: Record<string, Record<ThemePreference, string>> = {
		es: {
			light: 'Cambiar a tema oscuro',
			dark: 'Cambiar a tema del sistema',
			system: 'Cambiar a tema claro',
		},
		en: {
			light: 'Switch to dark theme',
			dark: 'Switch to system theme',
			system: 'Switch to light theme',
		},
	};

	const CYCLE: Record<ThemePreference, ThemePreference> = {
		light: 'dark',
		dark: 'system',
		system: 'light',
	};

	function getThemePreference(): ThemePreference {
		const stored = localStorage.getItem('theme');
		if (stored === 'light' || stored === 'dark') return stored;
		return 'system';
	}

	function getEffectiveTheme(preference: ThemePreference): 'light' | 'dark' {
		if (preference === 'system') {
			return window.matchMedia('(prefers-color-scheme: dark)').matches
				? 'dark'
				: 'light';
		}
		return preference;
	}

	function applyTheme(preference: ThemePreference): void {
		const effective = getEffectiveTheme(preference);
		document.documentElement.classList.toggle('dark', effective === 'dark');

		// Update icons visibility
		const sunIcon = document.getElementById(ICON_IDS.light);
		const moonIcon = document.getElementById(ICON_IDS.dark);
		const monitorIcon = document.getElementById(ICON_IDS.system);

		if (sunIcon)
			sunIcon.style.display = preference === 'light' ? 'block' : 'none';
		if (moonIcon)
			moonIcon.style.display = preference === 'dark' ? 'block' : 'none';
		if (monitorIcon)
			monitorIcon.style.display = preference === 'system' ? 'block' : 'none';

		// Resolve locale-aware labels
		const toggle = document.getElementById('theme-toggle');
		const locale = toggle?.getAttribute('data-locale') ?? 'es';
		const labels = LABELS[locale] ?? LABELS['es'];

		// Update button aria-label
		if (toggle) {
			toggle.setAttribute('aria-label', labels[preference]);
		}

		// Update tooltip text
		const wrapper = toggle?.closest('[data-tooltip]');
		if (wrapper instanceof HTMLElement) {
			wrapper.setAttribute('data-tooltip', labels[preference]);
		}
	}

	function cycleTheme(): void {
		const current = getThemePreference();
		const newTheme = CYCLE[current];

		if (newTheme === 'system') {
			localStorage.removeItem('theme');
		} else {
			localStorage.setItem('theme', newTheme);
		}

		applyTheme(newTheme);
	}

	function handleSystemThemeChange(): void {
		if (getThemePreference() === 'system') {
			applyTheme('system');
		}
	}

	function setup(): void {
		const toggle = document.getElementById('theme-toggle');
		if (!toggle) return;

		applyTheme(getThemePreference());
		toggle.addEventListener('click', cycleTheme);
	}

	// Primary initialization: runs when script loads (deferred, DOM is ready)
	setup();

	// Re-initialize on View Transitions navigation (if enabled in the future)
	document.addEventListener('astro:page-load', setup);

	// Global listener for OS theme changes
	window
		.matchMedia('(prefers-color-scheme: dark)')
		.addEventListener('change', handleSystemThemeChange);
</script>
