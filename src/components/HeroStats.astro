---
import { DEFAULT_LOCALE } from '../i18n/config';
import { useTranslations } from '../i18n/utils';

const locale = Astro.currentLocale ?? DEFAULT_LOCALE;
const t = useTranslations(locale);
---

<div
	class="mt-2 flex w-full items-center justify-evenly border-t border-border pt-6"
>
	<div class="text-center">
		<p
			class="text-2xl font-bold font-mono tracking-tight"
			data-count-to="12"
			data-count-suffix="+"
		>
			12+
		</p>
		<p class="text-xs font-mono uppercase tracking-wider text-muted-foreground">
			{t('hero.stats.years')}
		</p>
	</div>

	<div class="h-10 w-px bg-border" aria-hidden="true"></div>

	<div class="text-center">
		<p
			class="text-2xl font-bold font-mono tracking-tight"
			data-count-to="20"
			data-count-prefix="+"
		>
			+20
		</p>
		<p class="text-xs font-mono uppercase tracking-wider text-muted-foreground">
			{t('hero.stats.projects')}
		</p>
	</div>
</div>

<script>
	function setupCounters(): void {
		const counters = document.querySelectorAll<HTMLElement>('[data-count-to]');

		if (counters.length === 0) return;

		const STEP_DURATION_MS = 80;

		const prefersReducedMotion = window.matchMedia(
			'(prefers-reduced-motion: reduce)',
		);

		function animateCounter(el: HTMLElement): void {
			const target = parseInt(el.getAttribute('data-count-to') ?? '0', 10);
			const prefix = el.getAttribute('data-count-prefix') ?? '';
			const suffix = el.getAttribute('data-count-suffix') ?? '';
			const finalText = `${prefix}${target}${suffix}`;

			// Skip animation if user prefers reduced motion
			if (prefersReducedMotion.matches) {
				el.textContent = finalText;
				return;
			}

			let current = 0;
			el.textContent = `${prefix}0${suffix}`;

			const timer = setInterval(() => {
				current++;
				if (current >= target) {
					clearInterval(timer);
					el.textContent = finalText;
				} else {
					el.textContent = `${prefix}${current}${suffix}`;
				}
			}, STEP_DURATION_MS);
		}

		// Use IntersectionObserver to trigger animation when visible
		const observer = new IntersectionObserver(
			(entries) => {
				entries.forEach((entry) => {
					if (entry.isIntersecting) {
						const el = entry.target as HTMLElement;
						observer.unobserve(el);
						animateCounter(el);
					}
				});
			},
			{ threshold: 0.5 },
		);

		counters.forEach((counter) => observer.observe(counter));
	}

	// Primary initialization
	setupCounters();

	// Re-initialize on View Transitions navigation
	document.addEventListener('astro:page-load', setupCounters);
</script>
