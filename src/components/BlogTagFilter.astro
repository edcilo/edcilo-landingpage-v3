---
interface Props {
	tags: string[];
	filterLabel: string;
	allLabel: string;
	noResultsMessage: string;
}

const { tags, filterLabel, allLabel, noResultsMessage } = Astro.props;
---

<div class="blog-tag-filter mb-8" role="group" aria-label={filterLabel}>
	<div class="flex flex-wrap items-center justify-center gap-2">
		<button class="tag-filter-btn active" data-tag="all" aria-pressed="true">
			{allLabel}
		</button>
		{
			tags.map((tag) => (
				<button class="tag-filter-btn" data-tag={tag} aria-pressed="false">
					{tag}
				</button>
			))
		}
	</div>
	<p
		class="tag-filter-empty mt-8 hidden text-center font-mono text-sm text-muted-foreground"
		aria-live="polite"
	>
		{noResultsMessage}
	</p>
</div>

<script>
	function initTagFilter(): void {
		const buttons =
			document.querySelectorAll<HTMLButtonElement>('.tag-filter-btn');
		const grid = document.querySelector<HTMLElement>('[data-blog-grid]');
		const emptyMessage =
			document.querySelector<HTMLElement>('.tag-filter-empty');

		if (!buttons.length || !grid || !emptyMessage) return;

		const cards = grid.querySelectorAll<HTMLElement>('article[data-tags]');
		const empty: HTMLElement = emptyMessage;

		function setActiveTag(selectedTag: string): void {
			const newUrl =
				selectedTag === 'all'
					? window.location.pathname
					: `${window.location.pathname}?tag=${encodeURIComponent(selectedTag)}`;
			window.history.replaceState(null, '', newUrl);

			buttons.forEach((btn) => {
				const isActive = btn.dataset.tag === selectedTag;
				btn.classList.toggle('active', isActive);
				btn.setAttribute('aria-pressed', String(isActive));
			});

			let visibleCount = 0;
			cards.forEach((card) => {
				const cardTags = (card.dataset.tags ?? '').split(',');
				const isVisible =
					selectedTag === 'all' || cardTags.includes(selectedTag);

				card.classList.toggle('filtered-hidden', !isVisible);
				if (isVisible) visibleCount++;
			});

			empty.classList.toggle('hidden', visibleCount > 0);
		}

		buttons.forEach((btn) => {
			btn.addEventListener('click', () => {
				const tag = btn.dataset.tag ?? 'all';
				setActiveTag(tag);
			});
		});

		const urlParams = new URLSearchParams(window.location.search);
		const initialTag = urlParams.get('tag') ?? 'all';
		if (initialTag !== 'all') {
			setActiveTag(initialTag);
		}
	}

	document.addEventListener('astro:page-load', initTagFilter);
	initTagFilter();
</script>

<style>
	.tag-filter-btn {
		display: inline-flex;
		align-items: center;
		padding: 0.375rem 0.75rem;
		border-radius: 0.375rem;
		border: 1px solid var(--color-border);
		background-color: var(--color-muted);
		font-family: var(--font-mono), ui-monospace, monospace;
		font-size: 0.875rem;
		color: var(--color-muted-foreground);
		cursor: pointer;
		transition: all 0.2s ease-out;
	}

	.tag-filter-btn:hover {
		background-color: var(--color-accent);
		color: var(--color-accent-foreground);
	}

	.tag-filter-btn:focus-visible {
		outline: 2px solid var(--color-primary);
		outline-offset: 2px;
	}

	.tag-filter-btn.active {
		background-color: var(--color-foreground);
		color: var(--color-background);
		border-color: var(--color-foreground);
	}

	.tag-filter-btn.active:hover {
		opacity: 0.9;
	}

	:global(article[data-tags]) {
		transition:
			opacity 0.2s ease-out,
			transform 0.2s ease-out;
	}

	:global(article[data-tags].filtered-hidden) {
		opacity: 0;
		transform: scale(0.95);
		pointer-events: none;
		position: absolute;
		visibility: hidden;
	}

	@media (prefers-reduced-motion: reduce) {
		:global(article[data-tags]) {
			transition: none;
		}
	}
</style>
